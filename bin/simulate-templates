#!/usr/bin/env python

"""Simulate noiseless, infinite-resolution spectral templates for DESI.

TODO (@moustakas):
  * Simulate dopperlgangers, e.g., stars that pass the QSO selection criteria.
  * Generate QAplots.

"""
from __future__ import division, print_function

import os
import sys
import argparse

from desisim.io import write_templates
from desispec.log import get_logger

def main():

    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter,
                                     description='Simulate noiseless, infinite-resolution spectral templates for DESI.')
                                         
    parser.add_argument('-n','--nmodel', type=long, default=None, metavar='', 
                        help='number of model (template) spectra to generate (required input)')
    # Optional inputs.
    parser.add_argument('-o','--objtype', type=str, default='ELG', metavar='', 
                        help='object type (ELG, LRG, STAR, or FSTD)') 
    parser.add_argument('--minwave', type=float, default=3600, metavar='', 
                        help='minimum output wavelength range [Angstrom]')
    parser.add_argument('--maxwave', type=float, default=10000, metavar='', 
                        help='maximum output wavelength range [Angstrom]')
    parser.add_argument('--cdelt', type=float, default=2, metavar='', 
                        help='dispersion of output wavelength array [Angstrom/pixel]')
    parser.add_argument('-s', '--seed', type=long, default=None, metavar='', 
                        help='random number seed')
    # Boolean keywords.
    parser.add_argument('--no-colorcuts', action='store_true', 
                        help="""do not apply color cuts to select objects (only used for
                        object types ELG, LRG, and QSO)""")
    parser.add_argument('--no-templates', action='store_true', 
                        help="""do not generate templates
                        (but do generate the diagnostic plots if OUTFILE exists)""")
    parser.add_argument('--no-plots', action='store_true', 
                        help='do not generate diagnostic (QA) plots')
    # Output filenames.
    parser.add_argument('--outfile', type=str, default='OBJTYPE-templates.fits', metavar='', 
                        help='output FITS file name')
    parser.add_argument('--qafile', type=str, default='OBJTYPE-templates.pdf', metavar='', 
                        help='output file name for the diagnostic (QA) plots')
    
    # Objtype-specific defaults.
    bgs_parser = parser.add_argument_group('options for objtype=BGS')
    bgs_parser.add_argument('--zrange-bgs', type=float, default=(0.01,0.4), nargs=2, metavar='', 
                            help='minimum and maximum redshift')
    bgs_parser.add_argument('--rmagrange-bgs', type=float, default=(15.0,19.0), nargs=2, metavar='',
                            help='Minimum and maximum r-band (AB) magnitude range')

    elg_parser = parser.add_argument_group('options for objtype=ELG')
    elg_parser.add_argument('--zrange-elg', type=float, default=(0.6,1.6), nargs=2, metavar='', 
                            dest='zrange_elg', help='minimum and maximum redshift')
    elg_parser.add_argument('--rmagrange-elg', type=float, default=(21.0,23.4), nargs=2, metavar='',
                            dest='rmagrange_elg', help='Minimum and maximum r-band (AB) magnitude range')
    elg_parser.add_argument('--minoiiflux', type=float, default='1E-17', metavar='',
                            help='Minimum integrated [OII] 3727 flux')
    
    fstd_parser = parser.add_argument_group('options for objtype=FSTD')
    fstd_parser.add_argument('--vrad-fstd', type=float, default=(0,200), nargs=2, metavar='', 
                             help='mean and sigma radial velocity Gaussian prior (km/s)')
    fstd_parser.add_argument('--rmagrange-fstd', type=float, default=(16.0,19.0), nargs=2, metavar='',
                            help='Minimum and maximum r-band (AB) magnitude range')

    lrg_parser = parser.add_argument_group('options for objtype=LRG')
    lrg_parser.add_argument('--zrange-lrg', type=float, default=(0.5,1.1), nargs=2, metavar='', 
                            help='minimum and maximum redshift')
    lrg_parser.add_argument('--zmagrange-lrg', type=float, default=(19.0,20.5), nargs=2, metavar='',
                            help='Minimum and maximum z-band (AB) magnitude range')
    
    qso_parser = parser.add_argument_group('options for objtype=QSO')
    qso_parser.add_argument('--zrange-qso', type=float, default=(0.5,4.0), nargs=2, metavar='', 
                            help='minimum and maximum redshift')
    qso_parser.add_argument('--gmagrange-qso', type=float, default=(21.0,23.0), nargs=2, metavar='',
                            help='Minimum and maximum g-band (AB) magnitude range')
    
    star_parser = parser.add_argument_group('options for objtype=STAR')
    star_parser.add_argument('--vrad-star', type=float, default=(0,200), nargs=2, metavar='', 
                             help='mean and sigma radial velocity Gaussian prior (km/s)')
    star_parser.add_argument('--rmagrange-star', type=float, default=(18,23.4), nargs=2, metavar='',
                            help='Minimum and maximum r-band (AB) magnitude range')

    wd_parser = parser.add_argument_group('options for objtype=WD')
    wd_parser.add_argument('--vrad-wd', type=float, default=(0,200), nargs=2, metavar='', 
                             help='mean and sigma radial velocity Gaussian prior (km/s)')
    wd_parser.add_argument('--gmagrange-wd', type=float, default=(16.0,19.0), nargs=2, metavar='',
                            help='Minimum and maximum g-band (AB) magnitude range')

    args = parser.parse_args()
    if args.nmodel is None:
        parser.print_help()
        sys.exit(1)

    log = get_logger()
    objtype = args.objtype.upper()
    
    # Check that the right environment variables are set.
    envtype = objtype
    if envtype=='FSTD':
        envtype = 'STAR'
    for envvar in ['DESI_'+envtype+'_TEMPLATES']:
        if envvar not in os.environ:
            log.error('Missing ${} environment variable'.format(envvar))
            sys.exit(1)
    
    # Set default output file name.
    if args.outfile:
        outfile = args.outfile
        if outfile == 'OBJTYPE-templates.fits':
            outfile = objtype.lower()+'-templates.fits'
    else: 
        outfile = objtype.lower()+'-templates.fits'
    
    log.info('Building {} {} templates.'.format(args.nmodel, objtype))

    # Possible pack the optional inputs into a dictionary to be added to the
    # output FITS header.
    # cmd = " ".join(sys.argv)
    # header_comments = vars(args)

    # Call the right Class depending on the object type.
    if not args.no_templates:
        if objtype == 'BGS':
            log.warning('{} objtype not yet supported!'.format(objtype))
            sys.exit(1)

        elif objtype == 'ELG':
            from desisim.templates import ELG
            elg = ELG(nmodel=args.nmodel,minwave=args.minwave,maxwave=args.maxwave,
                      cdelt=args.cdelt,seed=args.seed)
            flux, wave, meta = elg.make_templates(zrange=args.zrange_elg,
                                                  rmagrange=args.rmagrange_elg,
                                                  minoiiflux=args.minoiiflux,
                                                  no_colorcuts=args.no_colorcuts)
            log.info('Writing {}'.format(outfile))
            write_templates(outfile, flux, wave, meta, objtype)

        elif objtype == 'LRG':
            from desisim.templates import LRG
            lrg = LRG(nmodel=args.nmodel,minwave=args.minwave,maxwave=args.maxwave,
                      cdelt=args.cdelt,seed=args.seed)
            flux, wave, meta = lrg.make_templates(zrange=args.zrange_lrg,
                                                  zmagrange=args.zmagrange_lrg,
                                                  no_colorcuts=args.no_colorcuts)
            log.info('Writing {}'.format(outfile))
            write_templates(outfile, flux, wave, meta, objtype)

        elif objtype == 'QSO':
            from desisim.templates import QSO
            qso = QSO(nmodel=args.nmodel,minwave=args.minwave,maxwave=args.maxwave,
                      cdelt=args.cdelt,seed=args.seed)
            flux, wave, meta = qso.make_templates(zrange=args.zrange_qso,
                                                  gmagrange=args.gmagrange_qso,
                                                  no_colorcuts=args.no_colorcuts)
            log.info('Writing {}'.format(outfile))
            write_templates(outfile, flux, wave, meta, objtype)

        elif objtype == 'STAR' or objtype == 'FSTD' or objtype == 'WD':
            from desisim.templates import STAR
            FSTD = objtype=='FSTD'
            WD = objtype=='WD'
            star = STAR(nmodel=args.nmodel,minwave=args.minwave,maxwave=args.maxwave,
                        cdelt=args.cdelt,seed=args.seed,FSTD=FSTD,WD=WD)
            if FSTD: # simulate an F-standard
                flux, wave, meta = star.make_templates(vrad_meansig=args.vrad_fstd,
                                                       rmagrange=args.rmagrange_fstd)
            elif WD: # simulate a white dwarf
                flux, wave, meta = star.make_templates(vrad_meansig=args.vrad_wd,
                                                       gmagrange=args.gmagrange_wd)
            else: # simulate a normal star
                flux, wave, meta = star.make_templates(vrad_meansig=args.vrad_star,
                                                       rmagrange=args.rmagrange_star)
            log.info('Writing {}'.format(outfile))
            write_templates(outfile, flux, wave, meta, objtype)

        else:
            log.warning('Object type {} not recognized'.format(objtype))
            sys.exit(1)
    
    # Generate diagnostic QAplots (just a placeholder right now).
    if not args.no_plots:
        import matplotlib.pyplot as plt
        if args.qafile:
            qafile = args.qafile
            if qafile == 'OBJTYPE-templates.pdf':
                qafile = objtype.lower()+'-templates.pdf'
            else: 
                qafile = objtype.lower()+'-templates.pdf'

if __name__ == '__main__':
    main()
